name: Deploy Function App

on:
  push:
    branches:
      - main  # Trigger the workflow on push to the main branch
  pull_request:
    branches:
      - main  # Trigger the workflow on pull requests to the main branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Azure CLI
        uses: azure/CLI@v1
        with:
          azcliversion: '2.30.0'  # Correct input for specifying Azure CLI version
          inlineScript: |
            az --version  # Example inline script to verify Azure CLI setup

      - name: Install jq
        run: sudo apt-get install jq

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}  # Make sure to store your Azure credentials as secrets

      - name: Deploy Function App & Function
        run: |
        
          # Deploy Function App
          az deployment group create \
            --resource-group "komatsu" \
            --template-file ./bicep/function.bicep \
            --parameters functionAppName=${{ secrets.FUNCTION_APP_NAME }} \
                       location=${{ secrets.LOCATION }} \
                       storageAccountName=${{ secrets.STORAGE_ACCOUNT_NAME }} \
                       appServicePlanName=${{ secrets.APP_SERVICE_PLAN_NAME }}

          #Deploy Functions code
          az functionapp deployment source config-zip \
            --src ./my-function-code.zip \
            --name ${{ secrets.FUNCTION_APP_NAME }} \
            --resource-group ${{ secrets.RESOURCE_GROUP }}


      # # Step 3: Install ZIP utility
      # - name: Install ZIP utility
      #   run: sudo apt-get install zip

      # # Step 4: Zip the function app code
      # - name: Zip Function App code
      #   run: |
      #     # Zip the contents of the 'src/MyFunctionApp' folder
      #     zip -r functionapp.zip ./src/MyFunctionApp

      # # Step 5: Deploy to Azure Function App
      # - name: Deploy to Azure Function App
      #   uses: azure/webapps-deploy@v2
      #   with:
      #     app-name: <YourFunctionAppName>  # Replace with your Azure Function App name
      #     slot-name: production  # Use 'production' or your staging slot
      #     package: functionapp.zip  # The ZIP file generated from the previous step
      #     publish-profile: ${{ secrets.AZURE_PUBLISH_PROFILE }}  # Azure publish profile from GitHub secrets

